;
; This file contains the VGA mode 0x13 setup and color palette
;

[bits 32]

global init_vga

global palette

section .text

    ; void init_vga()
    ; Initialize VGA mode (0x13)
    init_vga:
        pushad

        ; Set mode
        mov esi, mode0x13
        call set_regs

        ; Set up palette
        mov esi, palette
        call set_palette

        ; Clear screen
        mov edi, 0xa0000
        mov ax, 0x0000
        mov ecx, 0x20000
        rep stosw

        popad
        ret

    ; Set VGA mode
    set_regs:
        cli
        mov dx, 0x3C2
        lodsb
        out dx, al

        mov dx, 0x3DA
        lodsb
        out dx, al

        xor ecx, ecx
        mov dx, 0x3C4
    .l1:
        lodsb
        xchg al, ah
        mov al, cl
        out dx, ax
        inc ecx
        cmp cl, 4
        jbe .l1

        mov dx, 0x3D4
        mov ax, 0x0E11
        out dx, ax

        xor ecx, ecx
        mov dx,  0x3D4
    .l2:
        lodsb
        xchg al, ah
        mov al, cl
        out dx, ax
        inc ecx
        cmp cl, 0x18
        jbe .l2

        xor ecx, ecx
        mov dx, 0x3cE
    .l3:
        lodsb
        xchg al, ah
        mov al, cl
        out dx, ax
        inc ecx
        cmp cl, 8
        jbe .l3

        mov dx, 0x3DA
        in al, dx

        xor ecx, ecx
        mov dx, 0x3C0
    .l4:
        in ax, dx
        mov al, cl
        out dx, al
        lodsb
        out dx, al
        inc ecx
        cmp cl, 0x14
        jbe .l4

        mov al, 0x20
        out dx, al

        sti
        ret

    ; void set_palette()
    ; Set palette colors
    set_palette:
        push ax
        push cx
        push dx

        xor cx, cx
    .next_color:
        mov dx, 0x03C8
        mov al, cl
        out dx, al
        inc dx
        mov al, byte [esi]
        out dx, al
        inc esi
        mov al, byte [esi]
        out dx, al
        inc esi
        mov al, byte [esi]
        out dx, al
        inc esi

        inc cx
        cmp cx, 256
        jl .next_color

        pop dx
        pop cx
        pop ax
        ret

section .data

    ; 256 color RGB palette (6 bits per channel)
    palette     db 00, 00, 00, 15, 15, 15, 31, 31, 31, 47, 47, 47, 63, 63, 63
                db 15, 00, 00, 31, 00, 00, 47, 00, 00, 63, 00, 00, 00, 00, 00
                db 00, 15, 00, 00, 31, 00, 00, 47, 00, 00, 63, 00, 00, 00, 00
                db 00, 00, 15, 00, 00, 31, 00, 00, 47, 00, 00, 63, 00, 00, 00
                db 15, 15, 00, 31, 31, 00, 47, 47, 00, 63, 63, 00, 00, 00, 00
                db 15, 00, 15, 31, 00, 31, 47, 00, 47, 63, 00, 63, 00, 00, 00
                db 00, 15, 15, 00, 31, 31, 00, 47, 47, 00, 63, 63, 00, 00, 00
                db 15, 07, 00, 31, 15, 00, 47, 23, 00, 63, 31, 00, 00, 00, 00
                db 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
                db 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
                db 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
                db 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
                db 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
                db 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
                db 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
                db 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
                db 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
                db 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
                db 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
                db 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
                db 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
                db 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
                db 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
                db 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
                db 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
                db 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00
                db 03, 00, 63, 06, 00, 63, 09, 00, 63, 12, 00, 63, 15, 00, 63
                db 18, 00, 63, 21, 00, 63, 24, 00, 63, 27, 00, 63, 30, 00, 63
                db 33, 00, 63, 36, 00, 63, 39, 00, 63, 42, 00, 63, 45, 00, 63
                db 48, 00, 63, 51, 00, 63, 54, 00, 63, 57, 00, 63, 60, 00, 63
                db 63, 00, 63, 63, 00, 60, 63, 00, 57, 63, 00, 54, 63, 00, 51
                db 63, 00, 48, 63, 00, 45, 63, 00, 42, 63, 00, 39, 63, 00, 36
                db 63, 00, 33, 63, 00, 30, 63, 00, 27, 63, 00, 24, 63, 00, 21
                db 63, 00, 18, 63, 00, 15, 63, 00, 12, 63, 00, 09, 63, 00, 06
                db 63, 00, 03, 63, 00, 00, 63, 03, 00, 63, 06, 00, 63, 09, 00
                db 63, 12, 00, 63, 15, 00, 63, 18, 00, 63, 21, 00, 63, 24, 00
                db 63, 27, 00, 63, 30, 00, 63, 33, 00, 63, 36, 00, 63, 39, 00
                db 63, 42, 00, 63, 45, 00, 63, 48, 00, 63, 51, 00, 63, 54, 00
                db 63, 57, 00, 63, 60, 00, 63, 63, 00, 60, 63, 00, 57, 63, 00
                db 54, 63, 00, 51, 63, 00, 48, 63, 00, 45, 63, 00, 42, 63, 00
                db 39, 63, 00, 36, 63, 00, 33, 63, 00, 30, 63, 00, 27, 63, 00
                db 24, 63, 00, 21, 63, 00, 18, 63, 00, 15, 63, 00, 12, 63, 00
                db 09, 63, 00, 06, 63, 00, 03, 63, 00, 00, 63, 00, 00, 63, 03
                db 00, 63, 06, 00, 63, 09, 00, 63, 12, 00, 63, 15, 00, 63, 18
                db 00, 63, 21, 00, 63, 24, 00, 63, 27, 00, 63, 30, 00, 63, 33
                db 00, 63, 36, 00, 63, 39, 00, 63, 42, 00, 63, 45, 00, 63, 48
                db 00, 63, 51, 00, 63, 54, 00, 63, 57, 00, 63, 60, 00, 63, 63
                db 00, 60, 63, 00, 57, 63, 00, 54, 63, 00, 51, 63, 00, 48, 63
                db 00, 45, 63, 00, 42, 63, 00, 39, 63, 00, 36, 63, 00, 33, 63
                db 00, 30, 63, 00, 27, 63, 00, 24, 63, 00, 21, 63, 00, 18, 63
                db 00, 15, 63, 00, 12, 63, 00, 09, 63, 00, 06, 63, 00, 03, 63
                db 00, 00, 63

    ; VGA mode 0x13 register values
    mode0x13    db 0x63, 0x00, 0x03, 0x01, 0x0F, 0x00, 0x0E, 0x5F, 0x4F
                db 0x50, 0x82, 0x54, 0x80, 0xBF, 0x1F, 0x00, 0x41, 0x00
                db 0x00, 0x00, 0x00, 0x00, 0x00, 0x9C, 0x0E, 0x8F, 0x28
                db 0x40, 0x96, 0xB9, 0xA3, 0xFF, 0x00, 0x00, 0x00, 0x00
                db 0x00, 0x40, 0x05, 0x0F, 0xFF, 0x00, 0x01, 0x02, 0x03
                db 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B, 0x0C
                db 0x0D, 0x0E, 0x0F, 0x41, 0x00, 0x0F, 0x00, 0x00